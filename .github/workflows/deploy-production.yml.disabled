name: ğŸš€ Deploy to Production

# Trigger on:
# 1. Push to main (automatic)
# 2. Manual workflow dispatch (button in GitHub UI)
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: ğŸ”§ Deploy Backend (Render)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Trigger Render deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "ğŸ”¥ Deploying backend to Render..."
          
          RESPONSE=$(curl -s -X POST \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json")
          
          DEPLOY_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)
          
          if [ -z "$DEPLOY_ID" ]; then
            echo "âŒ Failed to trigger deployment"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          echo "âœ… Deployment triggered: $DEPLOY_ID"
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_ENV

      - name: â³ Wait for Render deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "â³ Polling deployment status..."
          
          for i in {1..60}; do
            STATUS=$(curl -s "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            
            echo "Status: $STATUS (attempt ${i}/60)"
            
            if [ "$STATUS" = "live" ]; then
              echo "âœ… Backend deployment complete!"
              exit 0
            elif [ "$STATUS" = "failed" ] || [ "$STATUS" = "canceled" ]; then
              echo "âŒ Deployment failed: $STATUS"
              exit 1
            fi
            
            sleep 10
          done
          
          echo "âš ï¸  Deployment timeout (10 minutes)"
          exit 1

      - name: ğŸ§ª Validate backend CORS
        run: |
          echo "ğŸ§ª Testing CORS headers..."
          sleep 15  # Wait for backend to stabilize
          
          RESPONSE=$(curl -s -X OPTIONS https://ava-api-production.onrender.com/api/v1/vapi-settings \
            -H "Origin: https://app.avafirstai.com" \
            -H "Access-Control-Request-Method: GET" -i)
          
          if echo "$RESPONSE" | grep -q "access-control-allow-origin: https://app.avafirstai.com"; then
            echo "âœ… CORS configured correctly"
          else
            echo "âŒ CORS validation failed"
            echo "$RESPONSE"
            exit 1
          fi

  deploy-frontend:
    name: ğŸŒ Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    needs: deploy-backend  # Wait for backend first
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: webapp/package-lock.json

      - name: ğŸ“¥ Install dependencies
        working-directory: ./webapp
        run: npm ci

      - name: ğŸ”¨ Build frontend
        working-directory: ./webapp
        run: npm run build

      - name: ğŸš€ Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./webapp
        run: |
          npm install -g vercel
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

      - name: â³ Wait for Vercel propagation
        run: sleep 15

      - name: ğŸ§ª Smoke test frontend
        run: |
          echo "ğŸ§ª Testing deployed frontend..."
          
          # Test 1: Homepage
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://app.avafirstai.com)
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Homepage accessible (200)"
          else
            echo "âŒ Homepage failed (${STATUS})"
            exit 1
          fi
          
          # Test 2: /api/config route
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://app.avafirstai.com/api/config)
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "401" ] || [ "$STATUS" = "403" ]; then
            echo "âœ… Config API route exists (${STATUS})"
          else
            echo "âŒ Config API failed (${STATUS})"
            exit 1
          fi
          
          # Test 3: /api/vapi-settings proxy
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://app.avafirstai.com/api/vapi-settings)
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "401" ] || [ "$STATUS" = "403" ]; then
            echo "âœ… VAPI proxy works (${STATUS})"
          else
            echo "âŒ VAPI proxy failed (${STATUS})"
            exit 1
          fi

  notify-success:
    name: ğŸ‰ Deployment Success
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: success()
    
    steps:
      - name: ğŸŠ Celebrate
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Backend deployed to Render"
          echo "âœ… Frontend deployed to Vercel"
          echo "âœ… All smoke tests passed"
          echo ""
          echo "ğŸŒ Live at: https://app.avafirstai.com"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
